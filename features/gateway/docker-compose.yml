version: '3.8'

networks:
  api_tier:
    external: true
    name: pmoves_api
  data_tier:
    external: true
    name: pmoves_data
  app_tier:
    external: true
    name: pmoves_app
  monitoring_tier:
    external: true
    name: pmoves_monitoring

services:
  tensorzero-clickhouse:
    image: clickhouse/clickhouse-server:24.12-alpine
    restart: unless-stopped
    environment:
      - CLICKHOUSE_USER=tensorzero
      - CLICKHOUSE_PASSWORD=tensorzero
      - CLICKHOUSE_DEFAULT_ACCESS_MANAGEMENT=1
    ports:
      - "8123:8123"
    volumes:
      - ./clickhouse-data:/var/lib/clickhouse
    networks:
      - data_tier
      - monitoring_tier
    # Security Hardening
    user: "101:101" # ClickHouse default non-root user
    cap_drop:
      - ALL
    cap_add:
      - SYS_NICE
      - NET_ADMIN
      - IPC_LOCK
    healthcheck:
      test: [ "CMD-SHELL", "wget --spider http://tensorzero:tensorzero@localhost:8123/ping" ]
      interval: 5s
      timeout: 2s
      retries: 5

  tensorzero-gateway:
    image: tensorzero/gateway:latest
    restart: unless-stopped
    command: [ "--config-file", "/app/config/tensorzero.toml" ]
    environment:
      # ClickHouse Connection
      - TENSORZERO_CLICKHOUSE_URL=http://tensorzero:tensorzero@tensorzero-clickhouse:8123/default
      # Dynamic API Keys
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - GOOGLE_API_KEY=${GOOGLE_API_KEY}
      - OPENROUTER_API_KEY=${OPENROUTER_API_KEY}
      - GLM_API_KEY=${GLM_API_KEY}
      - CF_ACCOUNT_ID=${CF_ACCOUNT_ID}
      - CF_API_TOKEN=${CF_API_TOKEN}
    volumes:
      - ./config:/app/config:ro
    depends_on:
      tensorzero-clickhouse:
        condition: service_healthy
    ports:
      - "3000:3000"
    networks:
      - api_tier
      - data_tier
      - monitoring_tier
    # Security Hardening
    user: "65532:65532" # Non-root distroless user
    read_only: true
    cap_drop:
      - ALL
    security_opt:
      - no-new-privileges:true
