# YAML anchor for app-tier env loading (matches id008 in main docker-compose.yml)
x-env-tier-app: &id008
  env_file:
    - env.shared
    - env.tier-app

services:
  wger:
    image: ${WGER_IMAGE:-ghcr.io/powerfulmoves/pmoves-health-wger:pmoves-latest}
    container_name: pmoves-wger
    restart: unless-stopped
    <<: *id008  # Use app-tier env loading (env.shared + env.tier-app)
    networks:
      pmoves_app:
        aliases:
          - pmoves-wger
          - wger
    environment:
      DJANGO_DEBUG: "${WGER_DJANGO_DEBUG:-False}"
      WGER_USE_GUNICORN: "${WGER_USE_GUNICORN:-True}"
      DJANGO_CLEAR_STATIC_FIRST: "${WGER_CLEAR_STATIC_FIRST:-True}"
      TIME_ZONE: "${WGER_TIME_ZONE:-America/New_York}"
      SITE_URL: "${WGER_SITE_URL:-http://localhost:8000}"
    volumes:
      - wger-static:/home/wger/static
      - wger-media:/home/wger/media

  wger-nginx:
    image: ${WGER_NGINX_IMAGE:-nginx:1.27-alpine}
    container_name: pmoves-wger-nginx
    restart: unless-stopped
    depends_on:
      - wger
    networks:
      pmoves_app:
        aliases:
          - pmoves-wger-nginx
    ports:
      - "${WGER_HOST_PORT:-8000}:80"
    volumes:
      - wger-static:/wger/static:ro
      - wger-media:/wger/media:ro
      - ./integrations/pr-kits/wger/nginx.conf:/etc/nginx/conf.d/default.conf:ro

  firefly:
    image: ${FIREFLY_IMAGE:-ghcr.io/powerfulmoves/pmoves-wealth:pmoves-latest}
    container_name: pmoves-firefly
    restart: unless-stopped
    <<: *id008  # Use app-tier env loading (env.shared + env.tier-app)
    networks:
      pmoves_app:
        aliases:
          - pmoves-firefly
          - firefly
    environment:
      # Keep secrets sourced from env files / runtime secrets. Do not inline defaults.
      APP_KEY: ${FIREFLY_APP_KEY}
      APP_ENV: ${FIREFLY_APP_ENV:-production}
      DB_CONNECTION: ${FIREFLY_DB_CONNECTION:-sqlite}
      DB_DATABASE: ${FIREFLY_DB_DATABASE:-/var/www/html/storage/database/database.sqlite}
      TRUSTED_PROXIES: ${FIREFLY_TRUSTED_PROXIES:-**}
      TZ: ${FIREFLY_TZ:-America/New_York}
    ports:
      - "${FIREFLY_PORT:-8800}:8080"
    volumes:
      - firefly-storage:/var/www/html/storage
      - ./integrations/pr-kits/firefly/nginx-buffers.conf:/etc/nginx/conf.d/zz_buffers.conf:ro

  open-notebook-surrealdb-ext:
    image: ${OPEN_NOTEBOOK_SURREAL_IMAGE:-surrealdb/surrealdb:v2}
    container_name: pmoves-open-notebook-surrealdb
    <<: *id008  # Use app-tier env loading (env.shared + env.tier-app)
    command: start --log info --user ${SURREL_USER} --pass ${SURREL_PASS} rocksdb:/mydata/mydatabase.db
    restart: unless-stopped
    user: "0:0"
    networks:
      pmoves_app:
        aliases:
          - pmoves-open-notebook-surrealdb
          - open-notebook-surrealdb-ext
    volumes:
      - ./data/open-notebook/surreal_data:/mydata

  open-notebook-ext:
    image: ${OPEN_NOTEBOOK_IMAGE:-ghcr.io/powerfulmoves/pmoves-open-notebook:pmoves-latest}
    # Default to the Open Notebook fork; override OPEN_NOTEBOOK_IMAGE to pin your own tag.
    container_name: pmoves-open-notebook-ext
    restart: unless-stopped
    <<: *id008  # Use app-tier env loading (env.shared + env.tier-app)
    depends_on:
      - open-notebook-surrealdb-ext
    networks:
      pmoves_app:
        aliases:
          - pmoves-open-notebook-ext
    environment:
      # UI talks to API on localhost inside container.
      API_URL: http://localhost:5055
    ports:
      - "${OPEN_NOTEBOOK_UI_PORT_EXT:-8504}:8502"    # UI (alternate port to avoid conflict)
      - "${OPEN_NOTEBOOK_API_PORT_EXT:-5056}:5055"  # API (alternate port)
    volumes:
      - ./data/open-notebook/notebook_data_ext:/app/data
    profiles:
      - alternate

  jellyfin-ext:
    image: ${JELLYFIN_IMAGE:-ghcr.io/powerfulmoves/pmoves-jellyfin:pmoves-latest}
    container_name: pmoves-jellyfin
    restart: unless-stopped
    user: "65532:65532"
    <<: *id008  # Use app-tier env loading (env.shared + env.tier-app)
    networks:
      pmoves_app:
        aliases:
          - pmoves-jellyfin
          - jellyfin
      pmoves_bus:
        aliases:
          - jellyfin
    environment:
      JELLYFIN_PublishedServerUrl: ${JELLYFIN_PUBLISHED_URL:-http://localhost:8096}
      JELLYFIN_MEDIA_ROOT: ${JELLYFIN_MEDIA_ROOT:-/media}
    ports:
      - "8096:8096"
    volumes:
      - ./data/jellyfin/config:/config
      - ./data/jellyfin/cache:/cache
      - ./data/jellyfin/transcode:/transcodes
      - ./data/jellyfin/media:/media

networks:
  pmoves_app:
    external: true
    name: pmoves_app
  pmoves_bus:
    external: true
    name: pmoves_bus

volumes:
  firefly-storage:
  wger-static:
  wger-media:
