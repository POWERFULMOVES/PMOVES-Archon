#!/usr/bin/env python3
"""Merge env.shared values into tier env files."""

from pathlib import Path

env_shared = Path("/home/pmoves/PMOVES.AI/pmoves/env.shared")
tier_files = [
    "env.tier-llm",
    "env.tier-agent",
    "env.tier-worker",
    "env.tier-media",
]

# Read env.shared into a dict
shared_values = {}
for line in env_shared.read_text().splitlines():
    if "=" in line and not line.startswith("#"):
        key, value = line.split("=", 1)
        shared_values[key] = value

print(f"Read {len(shared_values)} values from env.shared")

# Update each tier file with values from env.shared
for tier_file in tier_files:
    tier_path = Path(f"/home/pmoves/PMOVES.AI/pmoves/{tier_file}")
    if not tier_path.exists():
        print(f"Skipping {tier_file} (not found)")
        continue

    lines = tier_path.read_text().splitlines()
    updated = {}

    # First collect existing entries
    for line in lines:
        if line.startswith("#") or not line.strip():
            continue
        if "=" in line:
            key, value = line.split("=", 1)
            # Use value from env.shared if it exists and is not empty
            # otherwise use the existing value
            if key in shared_values and shared_values[key]:
                updated[key] = shared_values[key]
            else:
                updated[key] = value

    # Write back with header
    result = ["# Auto-generated by pmoves.tools.secrets_sync. Do not edit."]
    for key in sorted(updated.keys()):
        result.append(f"{key}={updated[key]}")

    tier_path.write_text("\n".join(result) + "\n")
    print(f"{tier_file}: {len(updated)} entries")
