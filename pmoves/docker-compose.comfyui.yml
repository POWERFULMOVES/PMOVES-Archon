services:
  comfyui:
    # ComfyUI is a creator-workstation component. This service is optional and
    # intended for local/dev convenience when you want n8n to call ComfyUI over
    # the docker network (see pmoves_comfy_gen flow).
    image: ${COMFYUI_IMAGE:-runpod/comfyui:latest}
    restart: unless-stopped
    environment:
      # Most ComfyUI images honor CLI_ARGS; if not, the image default should still bind :8188.
      - CLI_ARGS=--listen 0.0.0.0 --port 8188
    ports:
      - "${COMFYUI_HOST_PORT:-8188}:8188"
    volumes:
      # Keep all models/outputs persistent. If you prefer bind mounts, override with COMFYUI_DATA_DIR and adjust the mapping.
      - comfyui-data:/workspace
    profiles: ["creator"]
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              capabilities: [compute,utility]
              count: ${GPU_COUNT:-all}
    networks: [api_tier, data_tier]

networks:
  api_tier:
    external: true
    name: pmoves_api
  data_tier:
    external: true
    name: pmoves_data

volumes:
  comfyui-data: {}

