{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "title": "CHIT Geometry Packet (CGP) v2 - Extended with Attribution",
  "description": "CGP v2 extends v1 with Dirichlet attribution, hyperbolic encoding, and Merkle proofs for provable economic contribution tracking.",
  "type": "object",
  "required": [
    "spec",
    "super_nodes"
  ],
  "additionalProperties": true,
  "properties": {
    "spec": {
      "type": "string",
      "enum": ["chit.cgp.v0.1", "chit.cgp.v0.2"],
      "description": "Schema version - v0.2 supports attribution fields"
    },
    "summary": {
      "type": "string",
      "description": "Human-readable description of the CGP contents"
    },
    "meta": {
      "type": ["object", "null"],
      "additionalProperties": true,
      "description": "Extensible metadata for the entire packet"
    },
    "created_at": {
      "type": "string",
      "format": "date-time"
    },
    "updated_at": {
      "type": "string",
      "format": "date-time"
    },
    "attribution": {
      "$ref": "#/$defs/attribution",
      "description": "Top-level attribution for the entire packet"
    },
    "hyperbolic": {
      "$ref": "#/$defs/hyperbolic_encoding",
      "description": "Hyperbolic space encoding metadata"
    },
    "super_nodes": {
      "type": "array",
      "minItems": 1,
      "items": {
        "$ref": "#/$defs/super_node"
      }
    },
    "constellations": {
      "type": "array",
      "items": {
        "$ref": "#/$defs/constellation"
      }
    },
    "points": {
      "type": "array",
      "items": {
        "$ref": "#/$defs/point"
      }
    },
    "sig": {
      "oneOf": [
        { "type": "null" },
        { "type": "string" },
        { "$ref": "#/$defs/signature" }
      ]
    }
  },
  "$defs": {
    "attribution": {
      "type": "object",
      "description": "Dirichlet-weighted attribution tracking for provable contribution shares",
      "additionalProperties": true,
      "properties": {
        "dirichlet_alpha": {
          "type": "array",
          "items": { "type": "number", "minimum": 0 },
          "description": "Alpha parameters for Dirichlet distribution - pseudo-counts per contributor"
        },
        "total_alpha": {
          "type": "number",
          "minimum": 0,
          "description": "Sum of all alpha values (denominator for weight calculation)"
        },
        "contributors": {
          "type": "array",
          "items": { "$ref": "#/$defs/contributor" },
          "description": "List of contributors with their weights and contributions"
        },
        "merkle_root": {
          "type": "string",
          "pattern": "^0x[a-fA-F0-9]{64}$",
          "description": "Merkle tree root hash for all attribution records"
        },
        "merkle_strategy": {
          "type": "string",
          "enum": ["per_week", "rolling", "per_contract"],
          "description": "Strategy used for Merkle tree construction"
        },
        "week": {
          "type": "integer",
          "minimum": 0,
          "description": "Simulation week number for time-based attribution"
        },
        "decay_applied": {
          "type": "boolean",
          "description": "Whether contribution decay has been applied"
        },
        "timestamp": {
          "type": "string",
          "format": "date-time",
          "description": "When attribution was computed"
        }
      }
    },
    "contributor": {
      "type": "object",
      "description": "Individual contributor attribution record",
      "required": ["address", "weight"],
      "additionalProperties": true,
      "properties": {
        "address": {
          "type": "string",
          "description": "Contributor address/identifier"
        },
        "weight": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "Dirichlet-derived weight (E[X_i] = alpha_i / sum(alpha))"
        },
        "raw_contribution": {
          "type": "number",
          "description": "Original contribution amount before weighting"
        },
        "alpha_component": {
          "type": "number",
          "minimum": 0,
          "description": "Individual alpha parameter value"
        },
        "action_type": {
          "type": "string",
          "enum": [
            "token_received",
            "spending",
            "group_contribution",
            "staking",
            "voting",
            "loyalty_earned",
            "reward_claimed"
          ],
          "description": "Type of action that generated this contribution"
        },
        "category": {
          "type": "string",
          "description": "Category of contribution (e.g., 'groceries', 'grotoken')"
        },
        "proof": {
          "$ref": "#/$defs/merkle_proof",
          "description": "Merkle proof for this contribution"
        }
      }
    },
    "merkle_proof": {
      "type": "object",
      "description": "Cryptographic Merkle proof for attribution verification",
      "required": ["leaf_hash", "path"],
      "additionalProperties": true,
      "properties": {
        "leaf_hash": {
          "type": "string",
          "pattern": "^0x[a-fA-F0-9]{64}$",
          "description": "Hash of the leaf node (the attribution record)"
        },
        "path": {
          "type": "array",
          "items": {
            "type": "string",
            "pattern": "^0x[a-fA-F0-9]{64}$"
          },
          "description": "Sibling hashes from leaf to root"
        },
        "path_indices": {
          "type": "array",
          "items": {
            "type": "integer",
            "enum": [0, 1]
          },
          "description": "Position indicators (0=left, 1=right) for each path element"
        },
        "root": {
          "type": "string",
          "pattern": "^0x[a-fA-F0-9]{64}$",
          "description": "Expected Merkle root (for verification)"
        },
        "signature": {
          "type": "string",
          "description": "Optional cryptographic signature of the proof"
        }
      }
    },
    "hyperbolic_encoding": {
      "type": "object",
      "description": "Hyperbolic space encoding for hierarchical economic data",
      "additionalProperties": true,
      "properties": {
        "space": {
          "type": "string",
          "enum": ["poincare_disk", "lorentz", "klein", "hyperboloid"],
          "default": "poincare_disk",
          "description": "Model of hyperbolic space used"
        },
        "curvature": {
          "type": "number",
          "maximum": 0,
          "default": -1,
          "description": "Curvature of the hyperbolic space (must be negative)"
        },
        "base_radius": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "Base radius for first-level encoding"
        },
        "max_radius": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "default": 0.95,
          "description": "Maximum allowed radius (must be < 1 for Poincare disk)"
        },
        "points": {
          "type": "array",
          "items": { "$ref": "#/$defs/poincare_point" },
          "description": "Encoded points in hyperbolic space"
        },
        "hierarchy_depth": {
          "type": "integer",
          "minimum": 0,
          "description": "Maximum depth of encoded hierarchy"
        }
      }
    },
    "poincare_point": {
      "type": "object",
      "description": "Point in Poincare disk model (unit disk, |z| < 1)",
      "required": ["x", "y"],
      "additionalProperties": true,
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for this point"
        },
        "x": {
          "type": "number",
          "minimum": -1,
          "maximum": 1,
          "description": "X coordinate in Poincare disk"
        },
        "y": {
          "type": "number",
          "minimum": -1,
          "maximum": 1,
          "description": "Y coordinate in Poincare disk"
        },
        "r": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "Euclidean radius from origin = sqrt(x^2 + y^2)"
        },
        "theta": {
          "type": "number",
          "minimum": 0,
          "maximum": 6.283185307179586,
          "description": "Angular position in radians [0, 2pi)"
        },
        "label": {
          "type": "string",
          "description": "Human-readable label"
        },
        "depth": {
          "type": "integer",
          "minimum": 0,
          "description": "Hierarchy depth (0 = root/center)"
        },
        "parent_id": {
          "type": "string",
          "description": "ID of parent point in hierarchy"
        }
      }
    },
    "super_node": {
      "type": "object",
      "required": ["constellations"],
      "additionalProperties": true,
      "properties": {
        "id": { "type": "string" },
        "label": { "type": "string" },
        "summary": { "type": "string" },
        "x": { "type": "number" },
        "y": { "type": "number" },
        "r": { "type": "number" },
        "meta": {
          "type": ["object", "null"],
          "additionalProperties": true
        },
        "attribution": {
          "$ref": "#/$defs/attribution",
          "description": "Attribution specific to this super_node"
        },
        "hyperbolic": {
          "$ref": "#/$defs/hyperbolic_encoding",
          "description": "Hyperbolic encoding for this super_node's hierarchy"
        },
        "constellations": {
          "type": "array",
          "items": { "$ref": "#/$defs/constellation" }
        }
      }
    },
    "constellation": {
      "type": "object",
      "required": ["id", "points"],
      "additionalProperties": true,
      "properties": {
        "id": { "type": "string" },
        "summary": { "type": "string" },
        "anchor": {
          "type": "array",
          "items": { "type": "number" },
          "minItems": 1,
          "description": "Anchor vector for the constellation"
        },
        "anchor_enc": {
          "oneOf": [
            { "type": "null" },
            { "$ref": "#/$defs/encrypted_anchor" }
          ]
        },
        "radial_minmax": {
          "type": "array",
          "items": { "type": ["number", "null"] },
          "minItems": 2,
          "maxItems": 2
        },
        "spectrum": {
          "type": "array",
          "items": { "type": "number" },
          "minItems": 1,
          "description": "Dimensional values for multi-metric representation"
        },
        "attribution": {
          "$ref": "#/$defs/attribution",
          "description": "Attribution specific to this constellation"
        },
        "points": {
          "type": "array",
          "items": { "$ref": "#/$defs/point" }
        },
        "meta": {
          "type": ["object", "null"],
          "additionalProperties": true
        },
        "created_at": {
          "type": "string",
          "format": "date-time"
        },
        "updated_at": {
          "type": "string",
          "format": "date-time"
        }
      }
    },
    "point": {
      "type": "object",
      "required": ["id"],
      "additionalProperties": true,
      "properties": {
        "id": { "type": "string" },
        "modality": {
          "type": "string",
          "description": "Data modality - extended with economic types: economic_transaction, token_distribution, group_savings, staking_position, governance_vote, loyalty_event, reward_claim"
        },
        "mod": { "type": "string" },
        "ref_id": { "type": "string" },
        "source_ref": { "type": "string" },
        "video_id": { "type": "string" },
        "doc_id": { "type": "string" },
        "t_start": { "type": "number" },
        "t_end": { "type": "number" },
        "frame_idx": { "type": "integer" },
        "token_start": { "type": "integer" },
        "token_end": { "type": "integer" },
        "proj": { "type": "number" },
        "conf": { "type": "number" },
        "x": { "type": "number" },
        "y": { "type": "number" },
        "text": { "type": "string" },
        "char_len": { "type": "integer", "minimum": 0 },
        "word_count": { "type": "integer", "minimum": 0 },
        "token_range": {
          "type": "array",
          "items": { "type": "integer" },
          "minItems": 2,
          "maxItems": 2
        },
        "ts": {
          "type": "string",
          "format": "date-time"
        },
        "summary": { "type": "string" },
        "meta": {
          "type": ["object", "null"],
          "additionalProperties": true
        },
        "contributor": {
          "$ref": "#/$defs/contributor",
          "description": "Point-level attribution for individual economic events"
        },
        "amount": {
          "type": "number",
          "description": "Economic amount associated with this point"
        },
        "week": {
          "type": "integer",
          "minimum": 0,
          "description": "Simulation week for economic events"
        },
        "address": {
          "type": "string",
          "description": "Participant address for economic events"
        }
      }
    },
    "encrypted_anchor": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "alg": { "type": "string" },
        "iv": { "type": "string" },
        "salt": { "type": "string" },
        "ct": { "type": "string" },
        "tag": { "type": "string" }
      },
      "required": ["iv", "salt", "ct"]
    },
    "signature": {
      "type": "object",
      "additionalProperties": true,
      "required": ["alg", "hmac"],
      "properties": {
        "alg": { "type": "string" },
        "kid": { "type": "string" },
        "ts": { "type": ["integer", "string"] },
        "hmac": { "type": "string" },
        "meta": {
          "type": ["object", "null"],
          "additionalProperties": true
        }
      }
    }
  }
}
