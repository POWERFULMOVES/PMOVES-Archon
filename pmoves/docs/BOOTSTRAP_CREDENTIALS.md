# Bootstrap Credentials Script Reference

**Purpose:** Document the PMOVES.AI universal credential bootstrap script.

**Last Updated:** 2026-02-12

---

## Overview

The `bootstrap_credentials.sh` script provides universal credential loading for any PMOVES.AI submodule. It automatically discovers the parent PMOVES.AI repository and loads credentials with a fallback chain.

**Location:**
- Parent: `pmoves/scripts/bootstrap_credentials.sh`
- Submodule template: `scripts/bootstrap_credentials.sh`

---

## Usage

### Source the Script

```bash
# In any PMOVES.AI submodule directory
source scripts/bootstrap_credentials.sh

# Script will:
# 1. Find parent PMOVES.AI repository
# 2. Load credentials from parent
# 3. Create .env.bootstrap file
```

### Export Variables

```bash
# Source and export all variables
source scripts/bootstrap_credentials.sh
export $(grep -v '^#' .env.bootstrap)

# Or use directly
./scripts/bootstrap_credentials.sh && source .env.bootstrap
```

### Background Use

```bash
#!/bin/bash
# In your service startup script

# Load credentials
source scripts/bootstrap_credentials.sh

# Export all loaded variables
export $(grep -v '^#' .env.bootstrap)

# Start service
exec python -m my_service.main
```

---

## Fallback Chain

The script tries credential sources in order:

```
1. Parent PMOVES.AI (pmoves/env.shared + pmoves/.env)
   │
   │ (not found?)
   ▼
2. GitHub Secrets (gh CLI)
   │
   │ (not authenticated?)
   ▼
3. Manual setup required
```

### 1. Parent PMOVES.AI (Preferred)

**How it works:**
1. Searches upward from current directory
2. Looks for `pmoves/env.shared` or `pmoves/.env`
3. Loads variables from both files
4. Creates `.env.bootstrap` in current directory

**Output:**
```
✓ Found parent PMOVES.AI at: /path/to/PMOVES.AI
✓ Loading from env.shared...
✓ Loaded 42 variables from env.shared
✓ Merged parent .env credentials
✓ Bootstrapped 45 variables from parent PMOVES.AI
```

### 2. GitHub Secrets (Fallback)

**How it works:**
1. Checks if `gh` CLI is installed
2. Verifies authentication with `gh auth status`
3. Lists secrets from `POWERFULMOVES/PMOVES.AI` repo
4. Creates placeholders for credential secrets

**Pattern Matched:**
- `API_KEY`, `APIKEY` patterns
- `TOKEN` patterns
- `PASSWORD` patterns
- `SECRET` patterns

**Output:**
```
ℹ Attempting to load from GitHub Secrets...
ℹ Fetching secrets from POWERFULMOVES/PMOVES.AI...
⚠ - Added placeholder for OPENAI_API_KEY (use gh secret set to populate)
⚠ - Added placeholder for ANTHROPIC_API_KEY (use gh secret set to populate)
ℹ GitHub Secrets fetched - placeholders created. Use 'gh secret set' to populate values.
```

### 3. Manual Setup (Last Resort)

If both parent and GitHub sources fail, manual setup is required:

```
✗ Failed to bootstrap credentials from any source

Manual setup required:
1. Ensure parent PMOVES.AI repo exists with pmoves/.env populated
2. OR authenticate with GitHub: gh auth login
3. OR create .env file manually with required credentials
```

---

## Parent Discovery Algorithm

```
find_parent_pmoves() {
    current_dir="$(pwd)"

    # Check if in submodule
    if in_git_submodule; then
        git_root = get_git_root(current_dir)
        parent_dir = dirname(git_root)
    else
        # Go up one directory
        parent_dir = dirname(current_dir)
    fi

    # Check for PMOVES.AI markers
    if has_env_shared(parent_dir); then
        return parent_dir
    fi

    # Try grandparent (for nested structures)
    grandparent = dirname(parent_dir)
    if has_env_shared(grandparent); then
        return grandparent
    fi

    return not_found
}
```

**Detection Markers:**
- `pmoves/env.shared` exists
- `pmoves/.env` exists

---

## Output Format

### .env.bootstrap File

Created in the current directory with all exported variables:

```bash
# Generated by PMOVES.AI bootstrap script
# Source: parent PMOVES.AI
# Timestamp: 2026-02-12T10:00:00Z

# Infrastructure
NATS_URL=nats://nats:4222
TENSORZERO_URL=http://tensorzero:3030

# Service URLs
AGENT_ZERO_URL=http://agent-zero:8080
ARCHON_URL=http://archon:8091

# Credentials (masked in preview)
OPENAI_API_KEY=sk-***
ANTHROPIC_API_KEY=sk-ant-***

# Service configuration
LOG_LEVEL=INFO
```

### Masked Preview

The script shows a security-conscious preview with LLM provider keys masked:

```
Preview of loaded credentials:
OPENAI_API_KEY=***masked***
ANTHROPIC_API_KEY=***masked***
GOOGLE_API_KEY=***masked***
```

---

## Environment Variable Patterns

### Credential Variables

The script recognizes and loads these patterns:

| Pattern | Example | Purpose |
|---------|----------|---------|
| `*_API_KEY` | `OPENAI_API_KEY` | API authentication keys |
| `*_APIKEY` | `SERVICE_APIKEY` | API authentication (alt format) |
| `*_TOKEN` | `GITHUB_TOKEN` | Authentication tokens |
| `*_PASSWORD` | `DB_PASSWORD` | Password authentication |
| `*_SECRET` | `JWT_SECRET` | Secret values |

### Configuration Variables

| Variable | Example | Purpose |
|----------|----------|---------|
| `NATS_URL` | `nats://nats:4222` | NATS message bus |
| `TENSORZERO_URL` | `http://tensorzero:3030` | LLM gateway |
| `LOG_LEVEL` | `INFO` | Logging verbosity |
| `*_URL` | `SERVICE_URL` | Service endpoints |

---

## Integration Examples

### FastAPI Service

```python
import os
import subprocess
from fastapi import FastAPI

app = FastAPI()

@app.on_event("startup")
async def load_credentials():
    # Run bootstrap script
    subprocess.run(["bash", "scripts/bootstrap_credentials.sh"])

    # Source the output
    with open(".env.bootstrap") as f:
        for line in f:
            if line.strip() and not line.startswith("#"):
                key, value = line.split("=", 1)
                os.environ[key] = value
```

### Docker Compose

```yaml
services:
  my-service:
    image: ghcr.io/POWERFULMOVES/my-service:latest
    command: >
      sh -c "
        ./scripts/bootstrap_credentials.sh &&
        export $$(grep -v '^#' .env.bootstrap) &&
        exec python -m my_service.main
      "
```

### Systemd Service

```ini
[Service]
ExecStart=/bin/bash -c 'cd /path/to/service && ./scripts/bootstrap_credentials.sh && source .env.bootstrap && exec python -m my_service.main'
```

---

## Advanced Usage

### Custom Output File

```bash
# Specify custom output location
source scripts/bootstrap_credentials.sh
main "" "/custom/path/output.env"
```

### Programmatic Use

```python
import subprocess
import os

def bootstrap_credentials():
    result = subprocess.run(
        ["bash", "scripts/bootstrap_credentials.sh"],
        capture_output=True,
        text=True
    )

    # Parse output
    for line in result.stdout.splitlines():
        if "✓" in line or "=" in line:
            print(line)

    # Source the bootstrap file
    if os.path.exists(".env.bootstrap"):
        with open(".env.bootstrap") as f:
            for line in f:
                if "=" in line and not line.startswith("#"):
                    key, value = line.split("=", 1)
                    os.environ[key.strip()] = value.strip()
```

---

## Troubleshooting

### Parent Not Found

**Problem:** `✗ Failed to find parent PMOVES.AI repository`

**Solutions:**
1. Verify you're in a PMOVES.AI submodule
2. Ensure parent repo has `pmoves/env.shared`
3. Check directory structure is correct

### GitHub Not Authenticated

**Problem:** `⚠ Not logged into GitHub. Run: gh auth login`

**Solution:**
```bash
gh auth login
# Then retry bootstrap
```

### No Credentials Loaded

**Problem:** `⚠ Bootstrapped 0 variables`

**Solutions:**
1. Check parent `pmoves/.env` has credentials
2. Verify GitHub secrets are set
3. Check secret name patterns match expectations

### Variables Not Exported

**Problem:** Credentials loaded but not available to service

**Solution:**
```bash
# Make sure to source the output
source scripts/bootstrap_credentials.sh
export $(grep -v '^#' .env.bootstrap)
```

---

## Security Notes

### Key Masking

The script automatically masks LLM provider keys in preview output:
- OpenAI: `sk-***masked***`
- Anthropic: `sk-ant-***masked***`
- Google: `***masked***`

### Secret Storage

**Best Practices:**
1. Never commit `.env.bootstrap` to git
2. Add `.env.bootstrap` to `.gitignore`
3. Use GitHub Secrets for production values
4. Rotate credentials regularly

### Access Control

**File Permissions:**
```bash
# Set restrictive permissions on bootstrap output
chmod 600 .env.bootstrap
```

---

## Related Documentation

- [TIER_BASED_CREDENTIALS.md](TIER_BASED_CREDENTIALS.md) - Tier-based credential architecture
- [SECRETS_ONBOARDING.md](SECRETS_ONBOARDING.md) - Secret onboarding guide
- [CHIT_V2_SPECIFICATION.md](CHIT_V2_SPECIFICATION.md) - CHIT manifest format

---

**Maintainer:** PMOVES.AI Team
