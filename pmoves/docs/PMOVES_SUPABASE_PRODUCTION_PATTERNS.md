# PMOVES-supabase Production Patterns & Best Practices

**Date:** 2026-02-07

**Purpose:** Document production-ready patterns, utilities, and best practices from PMOVES-supabase fork for PMOVES.AI integration.

---

## Production Utilities

### 1. Database Password Rotation (`docker/utils/db-passwd.sh`)

**Purpose:** Safely rotate all PostgreSQL database passwords without downtime.

**Features:**
- Generates cryptographically secure hex passwords
- Updates all PostgreSQL roles (anon, authenticated, authenticator, etc.)
- Updates _analytics.source_backends for Logflare
- Recreates _supavisor schema
- Updates .env file automatically
- Requires confirmation before executing

**Roles Updated:**
- anon
- authenticated
- authenticator
- dashboard_user
- pgbouncer
- postgres
- service_role
- supabase_admin
- supabase_auth_admin
- supabase_functions_admin
- supabase_replication_admin
- supabase_storage_admin

**Usage:**
```bash
cd PMOVES-supabase/docker
./utils/db-passwd.sh
```

**Password Requirements:**
- Avoid special characters: `@/?#:&` in passwords
- Use hex-only passwords for SQL/shell compatibility

### 2. Key Generation (`docker/utils/generate-keys.sh`)

**Purpose:** Generate all required secrets for a fresh Supabase deployment.

**Generated Values:**
```bash
JWT_SECRET              # JWT signing secret (base64)
ANON_KEY                # Public API key (JWT)
SERVICE_ROLE_KEY        # Service role API key (JWT)
SECRET_KEY_BASE         # Rails secret key base (base64)
VAULT_ENC_KEY           # Vault encryption key (hex)
PG_META_CRYPTO_KEY      # Postgres meta encryption key (base64)
LOGFLARE_PUBLIC_ACCESS_TOKEN    # Analytics public token
LOGFLARE_PRIVATE_ACCESS_TOKEN   # Analytics private token
S3_PROTOCOL_ACCESS_KEY_ID       # S3 access key
S3_PROTOCOL_ACCESS_KEY_SECRET   # S3 secret key
POSTGRES_PASSWORD        # Database password
DASHBOARD_PASSWORD       # Dashboard login password
```

**Token Properties:**
- JWT tokens have 5-year expiration
- Uses HS256 algorithm
- Properly formatted for Supabase validation

**Usage:**
```bash
cd PMOVES-supabase/docker
./utils/generate-keys.sh
```

---

## Enterprise Patterns

### 1. Dynamic Table Partitioning

**Location:** `examples/enterprise-patterns/partitions/`

**Purpose:** Migrate large tables to partitioned structure with minimal downtime.

**Key Concepts:**
- Range partitioning by date
- Primary key must include partitioning column
- Supports online migration

**Example Schema:**
```sql
create table sales (
    id bigint generated by default as identity,
    order_date date not null,
    customer_id bigint,
    amount bigint,
    primary key (order_date, id)  -- Must include partition key
)
partition by range (order_date);

create table sales_2000_01
    partition of sales
    for values from ('2000-01-01') to ('2000-02-01');
```

**Best Practices:**
- Plan partitions before data growth
- Include partition key in primary key
- Use date-based partitioning for time-series data

### 2. Supachat Pattern

**Location:** `examples/enterprise-patterns/supachat/`

**Purpose:** Real-time chat application demonstrating advanced partitioning.

**Use Case:** High-volume message storage with efficient queries.

---

## Integration Examples

### 1. Cloudflare Workers Integration

**Location:** `examples/with-cloudflare-workers/`

**Pattern:** Query Supabase from edge workers.

**Setup:**
```bash
npm i @supabase/supabase-js
npx wrangler secret put SUPABASE_URL
npx wrangler secret put SUPABASE_ANON_KEY
```

**Usage:**
```javascript
import { createClient } from '@supabase/supabase-js'

const supabase = createClient(
  SUPABASE_URL,
  SUPABASE_ANON_KEY
)

const { data } = await supabase.from("articles").select("*")

return new Response(JSON.stringify(data), {
  headers: { "Content-Type": "application/json" }
})
```

**PMOVES.AI Application:**
- Edge functions for API acceleration
- Distributed request handling
- Global data access

### 2. User Management Patterns

**Available Frameworks:**
- Next.js
- React
- Vue 3
- Svelte/SvelteKit
- Angular
- Flutter
- Expo
- Solid.js

**Common Pattern:**
```typescript
import { createBrowserClient } from '@supabase/ssr'

export function createClient() {
  return createBrowserClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
  )
}
```

**CRITICAL:** Use `@supabase/ssr` package with `getAll()`/`setAll()` cookies methods.

### 3. Realtime Integration

**Examples:**
- Next.js Auth Presence
- Flutter Multiplayer Game
- Figma Clone

**Pattern:**
```typescript
const channel = supabase
  .channel('presence')
  .on('presence', { event: 'sync' }, () => {
    console.log('Synced presence state')
  })
  .subscribe()
```

**PMOVES.AI Application:**
- Agent Zero presence tracking
- Real-time collaboration
- Live dashboard updates

---

## Development Prompts (AI Guidelines)

### 1. RLS Policies (`prompts/database-rls-policies.md`)

**Key Rules:**
- Use `auth.uid()` instead of `current_user`
- SELECT policies: `USING` only
- INSERT policies: `WITH CHECK` only
- UPDATE policies: both `USING` and `WITH CHECK`
- DELETE policies: `USING` only
- Don't use `FOR ALL` - separate policies
- Discourage `RESTRICTIVE` policies

**Performance Recommendations:**
1. Add indexes on policy columns
2. Use `select auth.uid()` instead of `auth.uid()`
3. Minimize joins in policies
4. Always specify roles with `TO` clause

**Example:**
```sql
CREATE POLICY "Users can access their own records" ON test_table
  FOR SELECT TO authenticated
  USING ((select auth.uid()) = user_id);
```

### 2. Edge Functions (`prompts/edge-functions.md`)

**Key Guidelines:**
1. Use Web APIs over npm packages when possible
2. Shared utilities in `_shared` folder
3. Use `npm:` or `jsr:` specifiers (no bare imports)
4. Always pin dependency versions
5. Use `Deno.serve` instead of `https://deno.land/std/http/server.ts`
6. Pre-populated env vars: `SUPABASE_URL`, `SUPABASE_ANON_KEY`, `SUPABASE_SERVICE_ROLE_KEY`, `SUPABASE_DB_URL`
7. File writes only to `/tmp`
8. Use `EdgeRuntime.waitUntil()` for background tasks

**Example:**
```tsx
import { createClient } from 'npm:@supabase/supabase-js@2.39.0'

Deno.serve(async (req: Request) => {
  const supabase = createClient(
    Deno.env.get('SUPABASE_URL')!,
    Deno.env.get('SUPABASE_ANON_KEY')!
  )

  const { data } = await supabase.from('table').select('*')

  return new Response(JSON.stringify(data), {
    headers: { 'Content-Type': 'application/json' }
  })
})
```

### 3. Next.js Auth (`prompts/nextjs-supabase-auth.md`)

**CRITICAL WARNINGS:**
- ❌ NEVER use `auth-helpers-nextjs`
- ❌ NEVER use `get()`/`set()`/`remove()` cookies methods
- ✅ ALWAYS use `@supabase/ssr` with `getAll()`/`setAll()`

**Correct Pattern:**
```typescript
import { createServerClient } from '@supabase/ssr'
import { cookies } from 'next/headers'

export async function createClient() {
  const cookieStore = await cookies()

  return createServerClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      cookies: {
        getAll() {
          return cookieStore.getAll()
        },
        setAll(cookiesToSet) {
          cookiesToSet.forEach(({ name, value, options }) =>
            cookieStore.set(name, value, options)
          )
        }
      }
    }
  )
}
```

---

## PMOVES.AI Integration Recommendations

### 1. Security & Production Readiness

**Immediate Actions:**
1. Run `generate-keys.sh` to create production secrets
2. Store secrets securely (GitHub Secrets, Vault, etc.)
3. Implement password rotation schedule with `db-passwd.sh`
4. Enable RLS on all user data tables

### 2. Architecture Integration

**Supabase → PMOVES Services:**
```
┌─────────────────┐
│   Supabase      │
│  (Postgres)     │
└────────┬────────┘
         │
    ┌────┴────┐
    │         │
┌───▼───┐ ┌──▼─────┐
│ Archon│ │Agent   │
│       │ │Zero    │
└───────┘ └────────┘
```

**Integration Points:**
- **Archon:** Uses PostgREST for prompt/form storage
- **Agent Zero:** Connects via Supabase client libraries
- **NATS:** Webhooks publish to NATS subjects
- **MinIO:** Storage backend for file storage

### 3. Edge Functions for PMOVES

**Recommended Functions:**
1. `/functions/v1/agent-task` - Task creation endpoint
2. `/functions/v1/research-query` - Research queries
3. `/functions/v1/webhook-handler` - NATS webhook bridge
4. `/functions/v1/auth-middleware` - Custom auth logic

### 4. Realtime Channels for PMOVES

**Recommended Channels:**
- `agent-presence` - Agent availability tracking
- `task-updates` - Task status changes
- `research-progress` - Research progress updates
- `system-events` - System-wide events

### 5. Partitioning Strategy for PMOVES

**Tables to Consider:**
```sql
-- Agent sessions (time-series)
CREATE TABLE agent_sessions (
    id bigint generated by default as identity,
    session_start timestamp not null,
    agent_id uuid not null,
    -- other fields
    primary key (session_start, id)
) PARTITION BY RANGE (session_start);

-- Task logs (high-volume)
CREATE TABLE task_logs (
    id bigint generated by default as identity,
    created_at timestamp not null,
    task_id uuid not null,
    -- other fields
    primary key (created_at, id)
) PARTITION BY RANGE (created_at);
```

### 6. RLS Policy Template for PMOVES

```sql
-- Agent ownership
CREATE POLICY "Users can access their own agents"
ON agents
FOR ALL TO authenticated
USING ((select auth.uid()) = user_id);

-- Service role bypass
CREATE POLICY "Service role full access"
ON agents
FOR ALL TO service_role
USING (true);
```

---

## Environment Variable Standardization

### Required Variables for PMOVES.AI

```bash
# Standard Supabase (from PMOVES-supabase)
JWT_SECRET=*
JWT_EXPIRY=3600
ANON_KEY=*
SERVICE_ROLE_KEY=*
POSTGRES_PASSWORD=*
POSTGRES_HOST=supabase-db
POSTGRES_DB=pmoves
POSTGRES_PORT=5432

# PMOVES.AI specific
DOCKED_MODE=true
PARENT_SYSTEM=PMOVES.AI
PARENT_VERSION=1.0.0

# Integration
MINIO_ENDPOINT=http://minio:9000
NATS_URL=nats://nats:pmoves@nats:4222
```

---

## Migration Checklist

### Phase 1: Preparation
- [ ] Backup current database
- [ ] Generate new production keys
- [ ] Update env.shared with standard variable names
- [ ] Create migration plan

### Phase 2: Variable Migration
- [ ] Update docker-compose.yml variable references
- [ ] Remove old SUPABASE_* prefixed variables
- [ ] Add standard variable names to env.shared

### Phase 3: Service Integration
- [ ] Add missing services (imgproxy, meta, functions, analytics, vector, supavisor)
- [ ] Configure PMOVES networks
- [ ] Update service dependencies

### Phase 4: Testing
- [ ] Test authentication flow
- [ ] Test RLS policies
- [ ] Test realtime connections
- [ ] Test edge functions

### Phase 5: Production
- [ ] Run `db-passwd.sh` for password rotation
- [ ] Enable monitoring
- [ ] Configure backup strategy
- [ ] Document runbooks

---

## References

- PMOVES-supabase fork: `/PMOVES-supabase`
- Docker utilities: `PMOVES-supabase/docker/utils/`
- Enterprise patterns: `PMOVES-supabase/examples/enterprise-patterns/`
- Development prompts: `PMOVES-supabase/examples/prompts/`
- Integration examples: `PMOVES-supabase/examples/with-cloudflare-workers/`
- User management: `PMOVES-supabase/examples/user-management/`
- Realtime examples: `PMOVES-supabase/examples/realtime/`

---

**Status:** ✅ Documentation complete. Ready for production implementation.
