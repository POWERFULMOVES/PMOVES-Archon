version: "3.8"
name: pmoves-v5

services:
  # ---------- CORE ----------
  nats:
    image: nats:2.10-alpine
    restart: unless-stopped
    ports:
      - "4222:4222"
      - "8222:8222"
    profiles: ["core"]
    command: ["-js", "-m", "8222"]

  n8n:
    image: n8nio/n8n:latest
    restart: unless-stopped
    env_file: [.env]
    environment:
      - N8N_HOST=${N8N_HOST}
      - N8N_PORT=${N8N_PORT}
      - N8N_PROTOCOL=${N8N_PROTOCOL}
      - N8N_EDITOR_BASE_URL=http://${N8N_HOST}
      - N8N_PUBLIC_API_DISABLED=false
    ports:
      - "${N8N_PORT}:${N8N_PORT}"
    volumes:
      - n8n_data:/home/node/.n8n
      - ./services/n8n/workflows:/workflows
    command: ["n8n", "start", "--tunnel"]
    profiles: ["core"]

  # ---------- DATA LAYER ----------
  neo4j:
    image: neo4j:5
    restart: unless-stopped
    env_file: [.env]
    environment:
      - NEO4J_AUTH=neo4j/${NEO4J_PASSWORD}
      - NEO4J_dbms_security_procedures_unrestricted=apoc.*
      - NEO4J_PLUGINS=["apoc"]
    ports:
      - "7474:7474"
      - "7687:7687"
    volumes:
      - neo4j_data:/data
      - neo4j_logs:/logs
      - neo4j_plugins:/plugins
    profiles: ["data"]

  qdrant:
    image: qdrant/qdrant:latest
    restart: unless-stopped
    env_file: [.env]
    ports:
      - "${QDRANT__SERVICE__HTTP_PORT:-6333}:6333"
      - "${QDRANT__SERVICE__GRPC_PORT:-6334}:6334"
    volumes:
      - qdrant_data:/qdrant/storage
    profiles: ["data"]

  minio:
    image: quay.io/minio/minio:latest
    restart: unless-stopped
    env_file: [.env]
    command: server /data --console-address ":9001"
    ports:
      - "9000:9000"
      - "9001:9001"
    environment:
      - MINIO_ROOT_USER=${MINIO_ROOT_USER}
      - MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD}
    volumes:
      - minio_data:/data
    profiles: ["data"]

  # ---------- SUPABASE CE ----------
  supa-db:
    image: supabase/postgres:15.1.0.79
    restart: unless-stopped
    env_file: [.env]
    environment:
      - POSTGRES_PASSWORD=${SUPABASE_DB_PASSWORD}
      - POSTGRES_DB=postgres
    ports:
      - "5432:5432"
    volumes:
      - supabase_db:/var/lib/postgresql/data
      - ./services/supabase/init:/docker-entrypoint-initdb.d:ro
    healthcheck:
      test: ["CMD", "pg_isready", "-U", "postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
    profiles: ["data"]

  supa-kong:
    image: supabase/kong:2.8.1
    depends_on: [supa-db]
    restart: unless-stopped
    profiles: ["data"]
    environment:
      - KONG_DATABASE=off
      - KONG_DECLARATIVE_CONFIG=/var/lib/kong/kong.yml
    volumes:
      - kong_volume:/var/lib/kong
    ports:
      - "8000:8000"
      - "8443:8443"

  supa-auth:
    image: supabase/gotrue:v2.151.0
    restart: unless-stopped
    depends_on: [supa-db]
    env_file: [.env]
    environment:
      - GOTRUE_JWT_SECRET=${SUPABASE_JWT_SECRET}
      - GOTRUE_SITE_URL=http://${N8N_HOST}
      - GOTRUE_API_HOST=0.0.0.0
      - GOTRUE_DB_DRIVER=postgres
      - GOTRUE_DB_DATABASE_URL=postgres://postgres:${SUPABASE_DB_PASSWORD}@supa-db:5432/postgres
      - GOTRUE_DISABLE_SIGNUP=false
    ports:
      - "9999:9999"
    profiles: ["data"]

  supa-rest:
    image: supabase/postgrest:v12.0.2
    restart: unless-stopped
    depends_on: [supa-db]
    env_file: [.env]
    environment:
      - PGRST_DB_URI=postgres://postgres:${SUPABASE_DB_PASSWORD}@supa-db:5432/postgres
      - PGRST_DB_ANON_ROLE=anon
      - PGRST_SERVER_PORT=3000
      - PGRST_JWT_SECRET=${SUPABASE_JWT_SECRET}
    ports:
      - "3000:3000"
    profiles: ["data"]

  supa-realtime:
    image: supabase/realtime:v2.25.63
    restart: unless-stopped
    depends_on: [supa-db]
    env_file: [.env]
    environment:
      - DB_HOST=supa-db
      - DB_USER=postgres
      - DB_PASSWORD=${SUPABASE_DB_PASSWORD}
      - DB_NAME=postgres
      - API_PORT=4000
      - FLY_ALLOC_ID=dev
      - FLY_APP_NAME=dev
    ports:
      - "4000:4000"
    profiles: ["data"]

  supa-storage:
    image: supabase/storage-api:v0.48.8
    restart: unless-stopped
    depends_on: [supa-db, supa-rest]
    env_file: [.env]
    environment:
      - ANON_KEY=${SUPABASE_ANON_KEY}
      - SERVICE_KEY=${SUPABASE_SERVICE_ROLE_KEY}
      - POSTGREST_URL=http://supa-rest:3000
      - PGRST_JWT_SECRET=${SUPABASE_JWT_SECRET}
      - DATABASE_URL=postgres://postgres:${SUPABASE_DB_PASSWORD}@supa-db:5432/postgres
      - FILE_SIZE_LIMIT=52428800
    ports:
      - "5000:5000"
    volumes:
      - supabase_storage:/var/lib/storage
    profiles: ["data"]

  supa-studio:
    image: supabase/studio:20250313-9d5f651
    restart: unless-stopped
    depends_on: [supa-auth, supa-rest, supa-realtime, supa-storage]
    env_file: [.env]
    environment:
      - SUPABASE_PUBLIC_URL=http://supa-kong:8000
      - STUDIO_DEFAULT_ORGANIZATION=Cataclysm Studios Inc.
      - STUDIO_DEFAULT_PROJECT=PMOVES
      - SUPABASE_ANON_KEY=${SUPABASE_ANON_KEY}
      - SUPABASE_SERVICE_KEY=${SUPABASE_SERVICE_ROLE_KEY}
      - POSTGRES_PASSWORD=${SUPABASE_DB_PASSWORD}
      - JWT_SECRET=${SUPABASE_JWT_SECRET}
      - SUPABASE_URL=http://supa-kong:8000
      - API_URL=http://supa-auth:9999
      - DB_URL=postgres://postgres:${SUPABASE_DB_PASSWORD}@supa-db:5432/postgres
    ports:
      - "54323:3000"
    profiles: ["data"]

  # ---------- AGENTS ----------
  agent-zero:
    build: ./services/agent-zero
    restart: unless-stopped
    env_file: [.env]
    environment:
      - PORT=${AGENT_ZERO_PORT}
      - NATS_URL=nats://nats:4222
      - NEO4J_URL=bolt://neo4j:7687
      - QDRANT_URL=http://qdrant:6333
      - MINIO_ENDPOINT=http://minio:9000
      - PMOVES_CONTRACTS_DIR=/app/contracts
    depends_on:
      - nats
    ports:
      - "${AGENT_ZERO_PORT}:${AGENT_ZERO_PORT}"
    volumes:
      - ./contracts:/app/contracts:ro
      - ./services/common:/app/services/common:ro
    profiles: ["agents"]

  archon:
    build: ./services/archon
    restart: unless-stopped
    env_file: [.env]
    environment:
      - PORT=${ARCHON_PORT}
      - NATS_URL=nats://nats:4222
      - NEO4J_URL=bolt://neo4j:7687
      - QDRANT_URL=http://qdrant:6333
      - MINIO_ENDPOINT=http://minio:9000
      - PMOVES_CONTRACTS_DIR=/app/contracts
    depends_on:
      - nats
    ports:
      - "${ARCHON_PORT}:${ARCHON_PORT}"
    volumes:
      - ./contracts:/app/contracts:ro
      - ./services/common:/app/services/common:ro
    profiles: ["agents"]

  # ---------- WORKERS ----------
  analysis-echo:
    build: ./services/analysis-echo
    restart: unless-stopped
    environment:
      - NATS_URL=nats://nats:4222
    volumes:
      - ./contracts:/app/contracts:ro
      - ./services/common:/app/services/common:ro
    depends_on:
      - nats
    profiles: ["workers"]

  graph-linker:
    build: ./services/graph-linker
    restart: unless-stopped
    env_file: [.env]
    environment:
      - NATS_URL=nats://nats:4222
      - NEO4J_PASSWORD=${NEO4J_PASSWORD}
    depends_on:
      - nats
      - neo4j
    volumes:
      - ./contracts:/app/contracts:ro
      - ./services/common:/app/services/common:ro
      - ./services/graph-linker/migrations:/app/migrations:ro
    profiles: ["workers"]

  publisher:
    build: ./services/publisher
    restart: unless-stopped
    env_file: [.env]
    environment:
      - NATS_URL=nats://nats:4222
      - MINIO_ENDPOINT=${MINIO_ENDPOINT}
      - MINIO_USE_SSL=${MINIO_USE_SSL}
      - MINIO_ACCESS_KEY=${MINIO_ROOT_USER}
      - MINIO_SECRET_KEY=${MINIO_ROOT_PASSWORD}
      - JELLYFIN_URL=${JELLYFIN_URL}
      - JELLYFIN_API_KEY=${JELLYFIN_API_KEY}
      - MEDIA_LIBRARY_PATH=${MEDIA_LIBRARY_PATH}
    volumes:
      - media_library:/library
      - ./contracts:/app/contracts:ro
      - ./services/common:/app/services/common:ro
    depends_on:
      - nats
      - minio
    profiles: ["workers"]

  # ---------- GENERATIVE ----------
  ollama:
    image: ollama/ollama:latest
    restart: unless-stopped
    environment:
      - OLLAMA_KEEP_ALIVE=24h
    volumes:
      - ollama:/root/.ollama
    ports:
      - "${OLLAMA_PORT:-11434}:11434"
    deploy:
      resources:
        reservations:
          devices:
            - capabilities: ["gpu"]
    profiles: ["gen"]

  comfyui:
    image: ghcr.io/comfyanonymous/comfyui:latest
    restart: unless-stopped
    env_file: [.env]
    environment:
      - CLI_ARGS=--listen 0.0.0.0 --port ${COMFYUI_PORT}
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=all
    ports:
      - "${COMFYUI_PORT:-8188}:${COMFYUI_PORT:-8188}"
    volumes:
      - ./services/comfyui/models:/root/.cache/comfyui/models
      - ./services/comfyui/output:/root/ComfyUI/output
      - ./services/comfyui/output:/data/output
      - ./services/comfyui/custom_nodes:/root/ComfyUI/custom_nodes
    deploy:
      resources:
        reservations:
          devices:
            - capabilities: ["gpu"]
    profiles: ["gen"]

  comfy-watcher:
    build: ./services/comfy-watcher
    restart: unless-stopped
    env_file: [.env]
    environment:
      - MINIO_ENDPOINT=${MINIO_ENDPOINT}
      - MINIO_USE_SSL=${MINIO_USE_SSL}
      - MINIO_ACCESS_KEY=${MINIO_ROOT_USER}
      - MINIO_SECRET_KEY=${MINIO_ROOT_PASSWORD}
      - MINIO_BUCKET=${MINIO_BUCKET_COMFYUI}
      - PUBLIC_BASE_URL=${MINIO_EXTERNAL_ENDPOINT}
      - PRESIGN_EXPIRES_HOURS=${PRESIGN_EXPIRES_HOURS}
      - NATS_URL=nats://nats:4222
    volumes:
      - ./services/comfyui/output:/data/output:ro
      - comfy_watcher_state:/state
      - ./contracts:/app/contracts:ro
      - ./services/common:/app/services/common:ro
    depends_on:
      - minio
      - nats
    profiles: ["gen"]

  # ---------- OBSERVABILITY ----------
  prometheus:
    image: prom/prometheus:latest
    restart: unless-stopped
    volumes:
      - ./services/monitoring/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus_data:/prometheus
    ports:
      - "9090:9090"
    profiles: ["obs"]

  grafana:
    image: grafana/grafana:latest
    restart: unless-stopped
    volumes:
      - grafana_data:/var/lib/grafana
      - ./services/monitoring/provisioning:/etc/grafana/provisioning
    ports:
      - "3001:3000"
    profiles: ["obs"]

  # ---------- MEDIA ----------
  jellyfin:
    image: lscr.io/linuxserver/jellyfin:latest
    restart: unless-stopped
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Etc/UTC
    volumes:
      - jellyfin_config:/config
      - jellyfin_cache:/cache
      - media_library:/library
    ports:
      - "8096:8096"
    profiles: ["media"]

  # ---------- OPS ----------
  minio-bootstrap:
    image: minio/mc:latest
    restart: "no"
    env_file: [.env]
    entrypoint: ["/bin/sh","-c"]
    command: >
      "
      mc alias set pmoves http://minio:9000 ${MINIO_ROOT_USER} ${MINIO_ROOT_PASSWORD} &&
      mc mb -p pmoves/${MINIO_BUCKET_COMFYUI} || true &&
      mc ilm add --expire-days 365 --noncurrent-expire-days 90 pmoves/${MINIO_BUCKET_COMFYUI} || true &&
      echo 'MinIO bootstrap complete for bucket ${MINIO_BUCKET_COMFYUI}'
      "
    depends_on:
      - minio
    profiles: ["ops"]

volumes:
  n8n_data:
  neo4j_data:
  neo4j_logs:
  neo4j_plugins:
  qdrant_data:
  minio_data:
  supabase_db:
  supabase_storage:
  kong_volume:
  ollama:
  prometheus_data:
  grafana_data:
  media_library:
  jellyfin_config:
  jellyfin_cache:
  comfy_watcher_state:
