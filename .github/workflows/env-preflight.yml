name: Env Preflight

on:
  pull_request:
    branches: [main]
    paths:
      - 'pmoves/.env*'
      - 'pmoves/scripts/env_check.ps1'
      - 'pmoves/docs/LOCAL_DEV.md'
      - 'pmoves/docs/LOCAL_TOOLING_REFERENCE.md'
      - '.github/workflows/env-preflight.yml'
  workflow_dispatch: {}

jobs:
  preflight:
    name: Preflight (windows-latest)
    # NOTE: Uses windows-latest for Windows-specific environment validation
    # This is intentional as we need to validate Windows PowerShell scripts
    runs-on: windows-latest
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@v2
        with:
          egress-policy: audit
          allowed-endpoints: >
            github.com:443
            api.github.com:443

      - name: Checkout
        uses: actions/checkout@v6

      - name: Run PowerShell preflight (quick)
        shell: pwsh
        working-directory: pmoves
        run: |
          Write-Host "Running env preflight..."
          pwsh -NoProfile -File scripts/env_check.ps1 -Quick

      - name: Ensure templates present
        shell: bash
        run: |
          test -f pmoves/.env.example || { echo ".env.example missing"; exit 1; }
          test -f pmoves/.env.local.example || echo "warn: .env.local.example missing (optional)"
