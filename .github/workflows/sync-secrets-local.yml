name: Sync Secrets to Local Environment

on:
  workflow_dispatch:
    inputs:
      output_format:
        description: 'Output format'
        required: false
        default: 'cgp'
        type: choice
        options:
          - cgp
          - env

jobs:
  sync-secrets:
    name: Sync GitHub Secrets to Local
    runs-on: [self-hosted, ai-lab]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Sync Secrets to Local
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          Z_AI_API_KEY: ${{ secrets.Z_AI_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
          MISTRAL_API_KEY: ${{ secrets.MISTRAL_API_KEY }}
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
          XAI_API_KEY: ${{ secrets.XAI_API_KEY }}
          ELEVENLABS_API_KEY: ${{ secrets.ELEVENLABS_API_KEY }}
          VOYAGE_API_KEY: ${{ secrets.VOYAGE_API_KEY }}
          COHERE_API_KEY: ${{ secrets.COHERE_API_KEY }}
          FIREWORKS_AI_API_KEY: ${{ secrets.FIREWORKS_AI_API_KEY }}
          PERPLEXITYAI_API_KEY: ${{ secrets.PERPLEXITYAI_API_KEY }}
          TOGETHER_AI_API_KEY: ${{ secrets.TOGETHER_AI_API_KEY }}
          VENICE_API_KEY: ${{ secrets.VENICE_API_KEY }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          set -euo pipefail

          OUTPUT_DIR="/home/pmoves/PMOVES.AI/pmoves/data/chit"
          mkdir -p "$OUTPUT_DIR"
          CGP_FILE="$OUTPUT_DIR/env.cgp.json"

          echo "==> Syncing GitHub Secrets to local CGP bundle..."
          echo "    Output: $CGP_FILE"
          echo ""

          # Create Python script inline
          python3 << 'PYTHON_SCRIPT'
          import json
          import hashlib
          import os
          from pathlib import Path
          from datetime import datetime

          # Get secrets from environment (injected by env: block above)
          secret_names = [
              'ANTHROPIC_API_KEY', 'Z_AI_API_KEY', 'OPENAI_API_KEY',
              'OPENROUTER_API_KEY', 'GROQ_API_KEY', 'GEMINI_API_KEY',
              'GOOGLE_API_KEY', 'MISTRAL_API_KEY', 'DEEPSEEK_API_KEY',
              'XAI_API_KEY', 'ELEVENLABS_API_KEY', 'VOYAGE_API_KEY',
              'COHERE_API_KEY', 'FIREWORKS_AI_API_KEY', 'PERPLEXITYAI_API_KEY',
              'TOGETHER_AI_API_KEY', 'VENICE_API_KEY', 'CLOUDFLARE_API_TOKEN',
              'CLOUDFLARE_ACCOUNT_ID'
          ]

          def generate_anchor(label: str, salt: str = '') -> list:
              digest = hashlib.sha256(f'{label}{salt}'.encode()).digest()[:12]
              floats = []
              for i in range(3):
                  chunk = digest[i*4:(i+1)*4]
                  value = int.from_bytes(chunk, 'big') / 2**32
                  floats.append(round(value, 10))
              return floats

          # Build secrets dict
          secrets = {}
          for name in secret_names:
              value = os.environ.get(name)
              if value and value != '' and not value.startswith('${{'):
                  secrets[name] = value
                  print(f'  + {label}')
              else:
                  print(f'  - {label} (not set)')

          # Build CGP payload
          cgp = {
              'version': 'chit.cgp.v0.1',
              'namespace': 'pmoves.secrets',
              'description': f'GitHub Secrets synced at {datetime.now().isoformat()}',
              'points': []
          }

          for label, value in sorted(secrets.items()):
              anchor = generate_anchor(label)
              cgp['points'].append({
                  'label': label,
                  'value': value,
                  'anchor': anchor,
                  'encoding': 'cleartext'
              })

          # Write CGP file
          output_dir = Path('/home/pmoves/PMOVES.AI/pmoves/data/chit')
          output_dir.mkdir(parents=True, exist_ok=True)
          cgp_file = output_dir / 'env.cgp.json'
          cgp_file.write_text(json.dumps(cgp, indent=2))
          print(f'\n==> Wrote {len(cgp["points"])} secrets to {cgp_file}')
          PYTHON_SCRIPT

      - name: Summary
        run: |
          echo "==> Secrets synced successfully!"
          echo "    Location: /home/pmoves/PMOVES.AI/pmoves/data/chit/env.cgp.json"
          echo ""
          echo "To decode and use:"
          echo "  python3 -m pmoves.tools.mini_cli secrets decode"
          echo "  source pmoves/scripts/bootstrap_credentials.sh"
